From 7c0882a117412263a414261e41eae192700ea71e Mon Sep 17 00:00:00 2001
Message-ID: <7c0882a117412263a414261e41eae192700ea71e.1694474346.git.lorenzo@kernel.org>
In-Reply-To: <3ea0f4e652a7205b62a02a66637926a768c4d0be.1694474345.git.lorenzo@kernel.org>
References: <3ea0f4e652a7205b62a02a66637926a768c4d0be.1694474345.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Tue, 12 Sep 2023 00:41:09 +0200
Subject: [PATCH 13/13] mt7996: hack: fix compilation

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 mac80211.c   | 11 ++++++++---
 mt7996/mac.c |  2 +-
 mt7996/mcu.c |  6 +++---
 3 files changed, 12 insertions(+), 7 deletions(-)

diff --git a/mac80211.c b/mac80211.c
index 5a6428a4..da749a8c 100644
--- a/mac80211.c
+++ b/mac80211.c
@@ -1071,9 +1071,14 @@ mt76_rx_convert(struct mt76_dev *dev, struct sk_buff *skb,
 	status->enc_flags = mstat.enc_flags;
 	status->encoding = mstat.encoding;
 	status->bw = mstat.bw;
-	status->he_ru = mstat.he_ru;
-	status->he_gi = mstat.he_gi;
-	status->he_dcm = mstat.he_dcm;
+	//if (status->encoding == RX_ENC_EHT) {
+	//	status->eht.ru = mstat.eht.ru;
+	//	status->eht.gi = mstat.eht.gi;
+	//} else {
+		status->he_ru = mstat.he_ru;
+		status->he_gi = mstat.he_gi;
+		status->he_dcm = mstat.he_dcm;
+	//}
 	status->rate_idx = mstat.rate_idx;
 	status->nss = mstat.nss;
 	status->band = mstat.band;
diff --git a/mt7996/mac.c b/mt7996/mac.c
index 99e8e0c1..d1c86022 100644
--- a/mt7996/mac.c
+++ b/mt7996/mac.c
@@ -404,7 +404,7 @@ mt7996_mac_fill_rx_rate(struct mt7996_dev *dev,
 	case MT_PHY_TYPE_EHT_MU:
 		/* TODO: currently report rx rate with HE rate */
 		status->nss = nss;
-		status->encoding = RX_ENC_HE;
+		status->encoding = RX_ENC_VHT;
 		bw = min_t(int, bw, IEEE80211_STA_RX_BW_160);
 		i = min_t(int, i & 0xf, 11);
 		break;
diff --git a/mt7996/mcu.c b/mt7996/mcu.c
index dd722942..c28bf5aa 100644
--- a/mt7996/mcu.c
+++ b/mt7996/mcu.c
@@ -1115,7 +1115,7 @@ mt7996_mcu_sta_muru_tlv(struct mt7996_dev *dev, struct sk_buff *skb,
 	tlv = mt76_connac_mcu_add_tlv(skb, STA_REC_MURU, sizeof(*muru));
 
 	muru = (struct sta_rec_muru *)tlv;
-	muru->cfg.mimo_dl_en = vif->bss_conf.eht_mu_beamformer ||
+	muru->cfg.mimo_dl_en = /*vif->bss_conf.eht_mu_beamformer ||*/
 			       vif->bss_conf.he_mu_beamformer ||
 			       vif->bss_conf.vht_mu_beamformer ||
 			       vif->bss_conf.vht_mu_beamformee;
@@ -1171,10 +1171,10 @@ mt7996_is_ebf_supported(struct mt7996_phy *phy, struct ieee80211_vif *vif,
 		struct ieee80211_eht_cap_elem_fixed *pe = &pc->eht_cap_elem;
 
 		if (bfee)
-			return vif->bss_conf.eht_su_beamformee &&
+			return vif->bss_conf.vht_su_beamformee &&
 			       EHT_PHY(CAP0_SU_BEAMFORMEE, pe->phy_cap_info[0]);
 		else
-			return vif->bss_conf.eht_su_beamformer &&
+			return vif->bss_conf.vht_su_beamformer &&
 			       EHT_PHY(CAP0_SU_BEAMFORMER, pe->phy_cap_info[0]);
 	}
 
-- 
2.41.0

