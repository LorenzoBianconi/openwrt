From efaa9f10887fdbb78bb117eb51f9fcc2f26e1db6 Mon Sep 17 00:00:00 2001
Message-ID: <efaa9f10887fdbb78bb117eb51f9fcc2f26e1db6.1694475923.git.lorenzo@kernel.org>
In-Reply-To: <d87026d038d2ce988b66354bbe9a3b88c5397be4.1694475922.git.lorenzo@kernel.org>
References: <d87026d038d2ce988b66354bbe9a3b88c5397be4.1694475922.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Tue, 12 Sep 2023 00:41:09 +0200
Subject: [PATCH 13/13] mt7996: hack: fix compilation

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 mac80211.c   | 6 ++++++
 mt7996/mac.c | 6 ++++--
 mt7996/mcu.c | 6 +++---
 3 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/mac80211.c b/mac80211.c
index 5913e967..42ae3f54 100644
--- a/mac80211.c
+++ b/mac80211.c
@@ -1076,6 +1076,7 @@ mt76_rx_convert(struct mt76_dev *dev, struct sk_buff *skb,
 	status->enc_flags = mstat.enc_flags;
 	status->encoding = mstat.encoding;
 	status->bw = mstat.bw;
+#if 0
 	if (status->encoding == RX_ENC_EHT) {
 		status->eht.ru = mstat.eht.ru;
 		status->eht.gi = mstat.eht.gi;
@@ -1084,6 +1085,11 @@ mt76_rx_convert(struct mt76_dev *dev, struct sk_buff *skb,
 		status->he_gi = mstat.he_gi;
 		status->he_dcm = mstat.he_dcm;
 	}
+#endif
+	status->he_ru = mstat.he_ru;
+	status->he_gi = mstat.he_gi;
+	status->he_dcm = mstat.he_dcm;
+
 	status->rate_idx = mstat.rate_idx;
 	status->nss = mstat.nss;
 	status->band = mstat.band;
diff --git a/mt7996/mac.c b/mt7996/mac.c
index 5d194331..cac4b8d0 100644
--- a/mt7996/mac.c
+++ b/mt7996/mac.c
@@ -391,7 +391,8 @@ mt7996_mac_fill_rx_rate(struct mt7996_dev *dev,
 	case MT_PHY_TYPE_HE_EXT_SU:
 	case MT_PHY_TYPE_HE_TB:
 		status->nss = nss;
-		status->encoding = RX_ENC_HE;
+		//status->encoding = RX_ENC_HE;
+		status->encoding = RX_ENC_VHT;
 		i &= GENMASK(3, 0);
 
 		if (gi <= NL80211_RATE_INFO_HE_GI_3_2)
@@ -403,7 +404,8 @@ mt7996_mac_fill_rx_rate(struct mt7996_dev *dev,
 	case MT_PHY_TYPE_EHT_TRIG:
 	case MT_PHY_TYPE_EHT_MU:
 		status->nss = nss;
-		status->encoding = RX_ENC_EHT;
+		//status->encoding = RX_ENC_EHT;
+		status->encoding = RX_ENC_VHT;
 		i &= GENMASK(3, 0);
 
 		if (gi <= NL80211_RATE_INFO_EHT_GI_3_2)
diff --git a/mt7996/mcu.c b/mt7996/mcu.c
index dd722942..c28bf5aa 100644
--- a/mt7996/mcu.c
+++ b/mt7996/mcu.c
@@ -1115,7 +1115,7 @@ mt7996_mcu_sta_muru_tlv(struct mt7996_dev *dev, struct sk_buff *skb,
 	tlv = mt76_connac_mcu_add_tlv(skb, STA_REC_MURU, sizeof(*muru));
 
 	muru = (struct sta_rec_muru *)tlv;
-	muru->cfg.mimo_dl_en = vif->bss_conf.eht_mu_beamformer ||
+	muru->cfg.mimo_dl_en = /*vif->bss_conf.eht_mu_beamformer ||*/
 			       vif->bss_conf.he_mu_beamformer ||
 			       vif->bss_conf.vht_mu_beamformer ||
 			       vif->bss_conf.vht_mu_beamformee;
@@ -1171,10 +1171,10 @@ mt7996_is_ebf_supported(struct mt7996_phy *phy, struct ieee80211_vif *vif,
 		struct ieee80211_eht_cap_elem_fixed *pe = &pc->eht_cap_elem;
 
 		if (bfee)
-			return vif->bss_conf.eht_su_beamformee &&
+			return vif->bss_conf.vht_su_beamformee &&
 			       EHT_PHY(CAP0_SU_BEAMFORMEE, pe->phy_cap_info[0]);
 		else
-			return vif->bss_conf.eht_su_beamformer &&
+			return vif->bss_conf.vht_su_beamformer &&
 			       EHT_PHY(CAP0_SU_BEAMFORMER, pe->phy_cap_info[0]);
 	}
 
-- 
2.41.0

